{% load static %}
<!-- Interactive Sentiment Analysis Visualizations -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card shadow-lg border-0">
            <div class="card-header gradient-bg text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Interactive Analysis Visualizations
                </h3>
                <p class="mb-0 mt-2">Advanced visual insights into the sentiment analysis process</p>
            </div>
            <div class="card-body p-4">
                
                <!-- 1. Input Text Visualization - Token Importance Heatmap -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-highlighter me-2"></i>Token Importance Heatmap
                        </h4>
                        <div class="card border-primary">
                            <div class="card-body">
                                <div id="tokenHeatmap" class="token-heatmap">
                                    <!-- Tokens will be dynamically inserted here based on actual analysis -->
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <span class="badge bg-success me-2">Positive Influence</span>
                                        <span class="badge bg-danger me-2">Negative Influence</span>
                                        <span class="badge bg-secondary me-2">Neutral/Minor Impact</span>
                                        <span class="badge bg-warning me-2">High Importance</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Decision Flow Diagram -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-project-diagram me-2"></i>Decision Flow Diagram
                        </h4>
                        <div class="card border-info">
                            <div class="card-body">
                                <div class="text-center p-4" style="background: rgba(13,110,253,0.06); border-radius: 16px;">
                                    <picture>
                                        <source srcset="{% static 'images/FlowDiagram.jpg' %}" type="image/jpeg">
                                        <img src="{% static 'images/FlowDiagram.jpg' %}"
                                             alt="Decision Flow Diagram" 
                                             class="img-fluid rounded shadow-lg"
                                             style="width: 100%; max-width: 100%; height: auto; display: block !important; visibility: visible !important; margin: 0 auto; border-radius: 14px; box-shadow: 0 12px 36px rgba(0,0,0,0.28); object-fit: contain; border: 3px solid #0d6efd; background-color: #ffffff0d;"
                                             loading="eager">
                                    </picture>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">Visual representation of the model's decision-making process</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Include required libraries -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
/* Custom styles for visualizations */
.token-heatmap {
    font-size: 1.1rem;
    line-height: 1.8;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    min-height: 80px;
}

.token {
    display: inline-block;
    margin: 2px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.token:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.token.positive {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.token.negative {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.token.neutral {
    background: linear-gradient(135deg, #6c757d, #adb5bd);
    color: white;
}

.token.high-importance {
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
    border: 2px solid #ffc107;
}

/* Fixed Confidence Gauge Styles */
.confidence-gauge-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 200px;
}

.confidence-gauge-container {
    position: relative;
    display: inline-block;
    width: 150px;
    height: 150px;
}

.gauge-center-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.gauge-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4F46E5;
}

.gauge-label {
    text-align: center;
    margin-top: 10px;
}

.embedding-plot {
    height: 350px;
    background: white;
    border-radius: 0.5rem;
}

/* Flow diagram styles removed - now using static image */
</style>

<script>
// Real data from Django analysis - replace hardcoded values
const analysisData = {
    text: "{{ analysis.text|escapejs }}",
    finalClassification: "{{ analysis.final_classification|escapejs }}",
    level1Prediction: "{{ analysis.level1_prediction|escapejs }}",
    level2Prediction: "{{ analysis.level2_prediction|escapejs }}",
    level3Prediction: "{{ analysis.level3_prediction|escapejs }}",
    confidenceScores: {
        level1: {% if analysis.confidence_scores.level1 %}{{ analysis.confidence_scores.level1 }}{% else %}null{% endif %},
        level2: {% if analysis.confidence_scores.level2 %}{{ analysis.confidence_scores.level2 }}{% else %}null{% endif %},
        level3: {% if analysis.confidence_scores.level3 %}{{ analysis.confidence_scores.level3 }}{% else %}null{% endif %}
    }
};

// Function to analyze text and extract tokens with sentiment
function analyzeTextTokens(text) {
    // Simple tokenization and sentiment analysis
    // In a real implementation, this would come from your model
    const words = text.toLowerCase().split(/\s+/);
    const sentimentWords = {
        positive: ['good', 'great', 'excellent', 'amazing', 'wonderful', 'fantastic', 'incredible', 'potential', 'growth', 'success', 'profit', 'bullish', 'moon', 'pump', 'hodl', 'buy', 'strong', 'up', 'rise', 'gain'],
        negative: ['bad', 'terrible', 'awful', 'horrible', 'worst', 'crash', 'dump', 'bearish', 'sell', 'weak', 'down', 'fall', 'loss', 'scam', 'fraud', 'bubble', 'overpriced'],
        neutral: ['the', 'is', 'are', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during']
    };
    
    return words.map(word => {
        let sentiment = 'neutral';
        let importance = 0.3;
        
        if (sentimentWords.positive.includes(word)) {
            sentiment = 'positive';
            importance = 0.8 + Math.random() * 0.2;
        } else if (sentimentWords.negative.includes(word)) {
            sentiment = 'negative';
            importance = 0.8 + Math.random() * 0.2;
        } else if (sentimentWords.neutral.includes(word)) {
            sentiment = 'neutral';
            importance = 0.1 + Math.random() * 0.3;
        } else {
            // Unknown words get medium importance
            importance = 0.4 + Math.random() * 0.4;
        }
        
        return {
            word: word,
            sentiment: sentiment,
            importance: importance
        };
    });
}

// 1. Token Importance Heatmap - Using Real Text
function createTokenHeatmap() {
    const container = document.getElementById('tokenHeatmap');
    container.innerHTML = '';
    
    const tokens = analyzeTextTokens(analysisData.text);
    
    tokens.forEach(token => {
        const span = document.createElement('span');
        span.className = `token ${token.sentiment} ${token.importance > 0.7 ? 'high-importance' : ''}`;
        span.textContent = token.word;
        span.title = `Sentiment: ${token.sentiment}, Importance: ${(token.importance * 100).toFixed(1)}%`;
        container.appendChild(span);
    });
}

// 2. Decision Flow Diagram - Now using static image, no JavaScript needed

// Initialize all visualizations when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing visualizations...');
    
    // Initialize token heatmap
    try {
        createTokenHeatmap();
    } catch (error) {
        console.error('Error creating token heatmap:', error);
    }
    
    // Flow diagram is now a static image, no initialization needed
    
    console.log('Visualizations initialized');
});
</script>